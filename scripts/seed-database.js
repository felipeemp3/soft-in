const bcrypt = require("bcryptjs")
const { query } = require("../config/database")

async function seedDatabase() {
  try {
    console.log("üå± Poblando base de datos con datos de ejemplo...")

    // Usuarios de ejemplo
    const users = [
      {
        nombre_completo: "Mar√≠a Garc√≠a L√≥pez",
        documento: "12345678",
        tipo_documento: "CC",
        rol: "enfermera",
        programa_formacion: "Auxiliar de Enfermer√≠a",
        no_ficha: "ENF001",
        password: "enf123",
      },
      {
        nombre_completo: "Juan P√©rez Gonz√°lez",
        documento: "87654321",
        tipo_documento: "CC",
        rol: "aprendiz",
        programa_formacion: "T√©cnico en Sistemas",
        no_ficha: "2758493",
        password: "user123",
      },
      {
        nombre_completo: "Ana L√≥pez Mart√≠nez",
        documento: "11111111",
        tipo_documento: "CC",
        rol: "enfermera",
        programa_formacion: "T√©cnico en Enfermer√≠a",
        no_ficha: "ENF002",
        password: "enf123",
      },
      {
        nombre_completo: "Laura Mart√≠nez Ruiz",
        documento: "22222222",
        tipo_documento: "CC",
        rol: "aprendiz",
        programa_formacion: "Auxiliar de Enfermer√≠a",
        no_ficha: "2758494",
        password: "user123",
      },
      {
        nombre_completo: "Roberto Jim√©nez Vargas",
        documento: "66666666",
        tipo_documento: "CC",
        rol: "bienestar",
        programa_formacion: "Psicolog√≠a",
        no_ficha: "BIE001",
        password: "bien123",
      },
      {
        nombre_completo: "Miguel √Ångel Ram√≠rez",
        documento: "88888888",
        tipo_documento: "CC",
        rol: "vigilante",
        programa_formacion: "Seguridad y Vigilancia",
        no_ficha: "VIG001",
        password: "vig123",
      },
      {
        nombre_completo: "Sandra Mej√≠a Ospina",
        documento: "10101010",
        tipo_documento: "CC",
        rol: "administrativo",
        programa_formacion: "Administraci√≥n",
        no_ficha: "ADM001",
        password: "admin123",
      },
    ]

    // Insertar usuarios
    for (const user of users) {
      const hashedPassword = await bcrypt.hash(user.password, 12)

      const insertQuery = `
        INSERT INTO persona (
          nombre_completo, documento, tipo_documento, rol, 
          programa_formacion, no_ficha, estado_formacion, contrasena
        ) VALUES ($1, $2, $3, $4, $5, $6, 'Activo', $7)
        ON CONFLICT (documento) DO NOTHING
        RETURNING id_persona
      `

      const result = await query(insertQuery, [
        user.nombre_completo,
        user.documento,
        user.tipo_documento,
        user.rol,
        user.programa_formacion,
        user.no_ficha,
        hashedPassword,
      ])

      if (result.rows.length > 0) {
        console.log(`‚úÖ Usuario creado: ${user.nombre_completo} (${user.documento})`)
      } else {
        console.log(`‚ÑπÔ∏è  Usuario ya existe: ${user.documento}`)
      }
    }

    // Insertar datos de ejemplo adicionales
    await insertSampleData()

    console.log("üéâ Base de datos poblada exitosamente")
    console.log("\nüìã Usuarios de prueba:")
    console.log("üë©‚Äç‚öïÔ∏è Enfermera: 12345678 / enf123")
    console.log("üë®‚Äçüéì Aprendiz: 87654321 / user123")
    console.log("üè• Bienestar: 66666666 / bien123")
    console.log("üõ°Ô∏è Vigilante: 88888888 / vig123")
    console.log("üë®‚Äçüíº Admin: 10101010 / admin123")
  } catch (error) {
    console.error("‚ùå Error poblando base de datos:", error)
  }
}

async function insertSampleData() {
  try {
    // Insertar historial de ingresos
    const historialData = [
      [2, "2024-01-15", "07:30:00", "Ingreso normal"],
      [2, "2024-01-14", "08:00:00", "Ingreso normal"],
      [4, "2024-01-15", "08:15:00", "Ingreso normal"],
      [4, "2024-01-14", "08:10:00", "Llegada tard√≠a"],
    ]

    for (const [id_persona, fecha, hora, observacion] of historialData) {
      await query(
        "INSERT INTO historial_ingreso (id_persona, fecha_ingreso, hora_ingreso, observacion) VALUES ($1, $2, $3, $4) ON CONFLICT DO NOTHING",
        [id_persona, fecha, hora, observacion],
      )
    }

    // Insertar permisos
    const permisosData = [
      [2, "2024-01-10", "Cita m√©dica", "Aprobado"],
      [4, "2024-01-12", "Diligencias personales", "Pendiente"],
      [4, "2024-01-13", "Emergencia familiar", "Aprobado"],
    ]

    for (const [id_persona, fecha, motivo, estado] of permisosData) {
      await query(
        "INSERT INTO permiso (id_persona, fecha_solicitud, motivo, estado) VALUES ($1, $2, $3, $4) ON CONFLICT DO NOTHING",
        [id_persona, fecha, motivo, estado],
      )
    }

    // Insertar reportes m√©dicos
    const reportesData = [
      [2, "Revisi√≥n m√©dica general - Sin novedades", "2024-01-08"],
      [4, "Control de presi√≥n arterial - Normal", "2024-01-10"],
      [4, "Evaluaci√≥n nutricional - Recomendaciones diet√©ticas", "2024-01-12"],
    ]

    for (const [id_persona, descripcion, fecha] of reportesData) {
      await query(
        "INSERT INTO reporte_medico (id_persona, descripcion, fecha) VALUES ($1, $2, $3) ON CONFLICT DO NOTHING",
        [id_persona, descripcion, fecha],
      )
    }

    console.log("‚úÖ Datos de ejemplo insertados")
  } catch (error) {
    console.error("‚ùå Error insertando datos de ejemplo:", error)
  }
}

// Ejecutar si se llama directamente
if (require.main === module) {
  seedDatabase().catch(console.error)
}

module.exports = { seedDatabase }
